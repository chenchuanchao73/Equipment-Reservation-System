{"ast":null,"code":"var render = function render() {\n  var _vm = this,\n    _c = _vm._self._c;\n  return _c('div', {\n    staticClass: \"reservation-form\"\n  }, [_vm.loading ? _c('div', {\n    staticClass: \"loading-container\"\n  }, [_c('el-skeleton', {\n    attrs: {\n      \"rows\": 10,\n      \"animated\": \"\"\n    }\n  })], 1) : !_vm.equipment ? _c('div', {\n    staticClass: \"error-container\"\n  }, [_c('el-result', {\n    attrs: {\n      \"icon\": \"error\",\n      \"title\": _vm.$t('error.errorMessage'),\n      \"sub-title\": _vm.$t('equipment.notFound')\n    },\n    scopedSlots: _vm._u([{\n      key: \"extra\",\n      fn: function () {\n        return [_c('el-button', {\n          attrs: {\n            \"type\": \"primary\"\n          },\n          on: {\n            \"click\": function ($event) {\n              return _vm.$router.push('/equipment');\n            }\n          }\n        }, [_vm._v(\" \" + _vm._s(_vm.$t('equipment.list')) + \" \")])];\n      },\n      proxy: true\n    }])\n  })], 1) : _c('div', [_c('div', {\n    staticClass: \"back-link\"\n  }, [_c('el-button', {\n    attrs: {\n      \"icon\": \"el-icon-arrow-left\"\n    },\n    on: {\n      \"click\": function ($event) {\n        return _vm.$router.push(`/equipment/${_vm.equipment.id}`);\n      }\n    }\n  }, [_vm._v(\" \" + _vm._s(_vm.$t('common.back')) + \" \")])], 1), _c('h1', {\n    staticClass: \"page-title\"\n  }, [_vm._v(_vm._s(_vm.$t('reservation.form')))]), _c('el-card', {\n    staticClass: \"equipment-card\",\n    attrs: {\n      \"shadow\": \"never\"\n    }\n  }, [_c('div', {\n    staticClass: \"equipment-info\"\n  }, [_c('div', {\n    staticClass: \"equipment-image-container\"\n  }, [_c('img', {\n    staticClass: \"equipment-image\",\n    attrs: {\n      \"src\": _vm.equipment.image_path ? _vm.getFullImageUrl(_vm.equipment.image_path) : require('@/assets/upload.png'),\n      \"alt\": _vm.equipment.name\n    }\n  })]), _c('div', {\n    staticClass: \"equipment-details\"\n  }, [_c('h2', {\n    staticClass: \"equipment-name\"\n  }, [_vm._v(_vm._s(_vm.equipment.name))]), _c('p', {\n    staticClass: \"equipment-category\"\n  }, [_vm._v(_vm._s(_vm.equipment.category))]), _vm.equipment.location ? _c('div', {\n    staticClass: \"equipment-location\"\n  }, [_c('i', {\n    staticClass: \"el-icon-location\"\n  }), _vm._v(\" \" + _vm._s(_vm.equipment.location) + \" \")]) : _vm._e(), _c('el-tag', {\n    staticStyle: {\n      \"font-weight\": \"bold\",\n      \"padding\": \"0px 10px\",\n      \"font-size\": \"14px\"\n    },\n    attrs: {\n      \"type\": _vm.equipment.status === 'available' ? 'success' : 'warning',\n      \"size\": \"medium\"\n    }\n  }, [_vm._v(\" \" + _vm._s(_vm.equipment.status === 'available' ? _vm.$t('equipment.available') : _vm.$t('equipment.maintenance')) + \" \")])], 1)])]), _c('el-card', {\n    staticClass: \"form-card\",\n    attrs: {\n      \"shadow\": \"never\"\n    }\n  }, [_c('el-form', {\n    ref: \"reservationForm\",\n    attrs: {\n      \"model\": _vm.form,\n      \"rules\": _vm.rules,\n      \"label-position\": \"top\",\n      \"size\": \"medium\"\n    }\n  }, [_c('el-divider', [_vm._v(_vm._s(_vm.$t('reservation.reservationType')))]), _c('el-form-item', {\n    attrs: {\n      \"label\": _vm.$t('reservation.reservationType'),\n      \"prop\": \"reservationType\"\n    }\n  }, [_c('el-radio-group', {\n    on: {\n      \"change\": _vm.handleReservationTypeChange\n    },\n    model: {\n      value: _vm.form.reservationType,\n      callback: function ($$v) {\n        _vm.$set(_vm.form, \"reservationType\", $$v);\n      },\n      expression: \"form.reservationType\"\n    }\n  }, [_c('el-radio', {\n    attrs: {\n      \"label\": \"single\"\n    }\n  }, [_vm._v(_vm._s(_vm.$t('reservation.singleReservation')))]), _c('el-radio', {\n    attrs: {\n      \"label\": \"recurring\"\n    }\n  }, [_vm._v(_vm._s(_vm.$t('reservation.recurringReservation')))])], 1)], 1), _c('el-divider', [_vm._v(_vm._s(_vm.$t('reservation.selectTime')))]), _c('el-row', {\n    attrs: {\n      \"gutter\": 20\n    }\n  }, [_c('el-col', {\n    attrs: {\n      \"xs\": 24,\n      \"sm\": 12\n    }\n  }, [_c('el-form-item', {\n    attrs: {\n      \"label\": _vm.$t('reservation.startTime'),\n      \"prop\": \"startDateTime\"\n    }\n  }, [_c('el-date-picker', {\n    staticStyle: {\n      \"width\": \"100%\"\n    },\n    attrs: {\n      \"type\": \"datetime\",\n      \"placeholder\": _vm.$t('reservation.startTime'),\n      \"picker-options\": _vm.startPickerOptions\n    },\n    on: {\n      \"change\": _vm.checkTimeAvailability\n    },\n    model: {\n      value: _vm.form.startDateTime,\n      callback: function ($$v) {\n        _vm.$set(_vm.form, \"startDateTime\", $$v);\n      },\n      expression: \"form.startDateTime\"\n    }\n  })], 1)], 1), _c('el-col', {\n    attrs: {\n      \"xs\": 24,\n      \"sm\": 12\n    }\n  }, [_c('el-form-item', {\n    attrs: {\n      \"label\": _vm.$t('reservation.endTime'),\n      \"prop\": \"endDateTime\"\n    }\n  }, [_c('el-date-picker', {\n    staticStyle: {\n      \"width\": \"100%\"\n    },\n    attrs: {\n      \"type\": \"datetime\",\n      \"placeholder\": _vm.$t('reservation.endTime'),\n      \"picker-options\": _vm.endPickerOptions\n    },\n    on: {\n      \"change\": _vm.checkTimeAvailability\n    },\n    model: {\n      value: _vm.form.endDateTime,\n      callback: function ($$v) {\n        _vm.$set(_vm.form, \"endDateTime\", $$v);\n      },\n      expression: \"form.endDateTime\"\n    }\n  })], 1)], 1)], 1), _vm.timeConflict ? _c('div', {\n    staticClass: \"time-conflict-warning\"\n  }, [_c('el-alert', {\n    attrs: {\n      \"title\": _vm.$t('reservation.timeConflict'),\n      \"type\": \"error\",\n      \"closable\": false,\n      \"show-icon\": \"\"\n    }\n  })], 1) : _vm._e(), _c('el-divider', [_vm._v(_vm._s(_vm.$t('common.userInfo')))]), _c('el-row', {\n    attrs: {\n      \"gutter\": 20\n    }\n  }, [_c('el-col', {\n    attrs: {\n      \"xs\": 24,\n      \"sm\": 12\n    }\n  }, [_c('el-form-item', {\n    attrs: {\n      \"label\": _vm.$t('reservation.userName'),\n      \"prop\": \"userName\"\n    }\n  }, [_c('el-input', {\n    model: {\n      value: _vm.form.userName,\n      callback: function ($$v) {\n        _vm.$set(_vm.form, \"userName\", $$v);\n      },\n      expression: \"form.userName\"\n    }\n  })], 1)], 1), _c('el-col', {\n    attrs: {\n      \"xs\": 24,\n      \"sm\": 12\n    }\n  }, [_c('el-form-item', {\n    attrs: {\n      \"label\": _vm.$t('reservation.userDepartment'),\n      \"prop\": \"userDepartment\"\n    }\n  }, [_c('el-input', {\n    model: {\n      value: _vm.form.userDepartment,\n      callback: function ($$v) {\n        _vm.$set(_vm.form, \"userDepartment\", $$v);\n      },\n      expression: \"form.userDepartment\"\n    }\n  })], 1)], 1)], 1), _c('el-row', {\n    attrs: {\n      \"gutter\": 20\n    }\n  }, [_c('el-col', {\n    attrs: {\n      \"xs\": 24,\n      \"sm\": 12\n    }\n  }, [_c('el-form-item', {\n    attrs: {\n      \"label\": _vm.$t('reservation.userContact'),\n      \"prop\": \"userContact\"\n    }\n  }, [_c('el-input', {\n    model: {\n      value: _vm.form.userContact,\n      callback: function ($$v) {\n        _vm.$set(_vm.form, \"userContact\", $$v);\n      },\n      expression: \"form.userContact\"\n    }\n  })], 1)], 1), _c('el-col', {\n    attrs: {\n      \"xs\": 24,\n      \"sm\": 12\n    }\n  }, [_c('el-form-item', {\n    attrs: {\n      \"label\": _vm.$t('reservation.userEmail'),\n      \"prop\": \"userEmail\"\n    }\n  }, [_c('el-input', {\n    attrs: {\n      \"type\": \"email\"\n    },\n    model: {\n      value: _vm.form.userEmail,\n      callback: function ($$v) {\n        _vm.$set(_vm.form, \"userEmail\", $$v);\n      },\n      expression: \"form.userEmail\"\n    }\n  })], 1)], 1)], 1), _c('el-form-item', {\n    attrs: {\n      \"label\": _vm.$t('reservation.purpose'),\n      \"prop\": \"purpose\"\n    }\n  }, [_c('el-input', {\n    attrs: {\n      \"type\": \"textarea\",\n      \"rows\": 3\n    },\n    model: {\n      value: _vm.form.purpose,\n      callback: function ($$v) {\n        _vm.$set(_vm.form, \"purpose\", $$v);\n      },\n      expression: \"form.purpose\"\n    }\n  })], 1), _c('el-form-item', [_c('el-button', {\n    attrs: {\n      \"type\": \"primary\",\n      \"loading\": _vm.submitting,\n      \"disabled\": _vm.timeConflict,\n      \"icon\": \"el-icon-plus\"\n    },\n    on: {\n      \"click\": _vm.submitForm\n    }\n  }, [_vm._v(\" \" + _vm._s(_vm.$t('reservation.createReservation')) + \" \")]), _c('el-button', {\n    attrs: {\n      \"icon\": \"el-icon-refresh-left\"\n    },\n    on: {\n      \"click\": _vm.resetForm\n    }\n  }, [_vm._v(_vm._s(_vm.$t('common.reset')))])], 1)], 1)], 1), _c('el-dialog', {\n    attrs: {\n      \"title\": _vm.$t('reservation.createSuccess'),\n      \"visible\": _vm.successDialogVisible,\n      \"width\": \"500px\",\n      \"close-on-click-modal\": false,\n      \"close-on-press-escape\": false,\n      \"show-close\": false\n    },\n    on: {\n      \"update:visible\": function ($event) {\n        _vm.successDialogVisible = $event;\n      }\n    }\n  }, [_c('div', {\n    staticClass: \"success-content\"\n  }, [_c('i', {\n    staticClass: \"el-icon-success success-icon\"\n  }), _c('p', {\n    staticClass: \"success-message\"\n  }, [_vm._v(_vm._s(_vm.$t('reservation.saveReservationCode')))]), _c('div', {\n    staticClass: \"reservation-code\"\n  }, [_vm._v(\" \" + _vm._s(_vm.reservationCode) + \" data() { // 表单验证规则 const validateTime = (rule, value, callback) => { if (!value) { callback(new Error(this.$t('reservation.requiredField'))) } else if (this.form.startDateTime && this.form.endDateTime) { if (this.form.startDateTime >= this.form.endDateTime) { callback(new Error(this.$t('reservation.invalidTime'))) } else { callback() } } else { callback() } } const validateEmail = (rule, value, callback) => { if (!value) { callback() } else { const emailRegex = /^[^\\\\s@]+@[^\\\\s@]+\\\\.[^\\\\s@]+$/ if (!emailRegex.test(value)) { callback(new Error(this.$t('reservation.emailFormat'))) } else { callback() } } } return { loading: false, submitting: false, equipment: null, timeConflict: false, successDialogVisible: false, reservationCode: '', qrcodeUrl: '', form: { reservationType: 'single', // 默认为单次预约 startDateTime: '', endDateTime: '', userName: '', userDepartment: '', userContact: '', userEmail: '', purpose: '' }, rules: { reservationType: [ { required: true, message: this.$t('reservation.requiredField'), trigger: 'change' } ], startDateTime: [ { required: true, message: this.$t('reservation.requiredField'), trigger: 'change' }, { validator: validateTime, trigger: 'change' } ], endDateTime: [ { required: true, message: this.$t('reservation.requiredField'), trigger: 'change' }, { validator: validateTime, trigger: 'change' } ], userName: [ { required: true, message: this.$t('reservation.requiredField'), trigger: 'blur' }, { min: 2, max: 50, message: this.$t('common.lengthLimit', { min: 2, max: 50 }), trigger: 'blur' } ], userDepartment: [ { required: true, message: this.$t('reservation.requiredField'), trigger: 'blur' }, { min: 2, max: 50, message: this.$t('common.lengthLimit', { min: 2, max: 50 }), trigger: 'blur' } ], userContact: [ { required: true, message: this.$t('reservation.requiredField'), trigger: 'blur' }, { min: 5, max: 50, message: this.$t('common.lengthLimit', { min: 5, max: 50 }), trigger: 'blur' } ], userEmail: [ { required: true, message: this.$t('reservation.requiredField'), trigger: 'blur' }, { validator: validateEmail, trigger: 'blur' } ], purpose: [ { max: 500, message: this.$t('common.lengthLimit', { max: 500 }), trigger: 'blur' } ] }, startPickerOptions: { disabledDate(time) { return time.getTime() < Date.now() - 8.64e7 // 不能选择过去的日期 } }, endPickerOptions: { disabledDate(time) { return time.getTime() < Date.now() - 8.64e7 // 不能选择过去的日期 } } } }, created() { this.fetchEquipment() }, methods: { async fetchEquipment() { this.loading = true try { const equipmentId = this.$route.params.id const response = await equipmentApi.getEquipment(equipmentId) this.equipment = response.data if (this.equipment.status !== 'available') { this.$message.warning(this.$t('equipment.notAvailable')) } } catch (error) { console.error('Failed to fetch equipment:', error) this.$message.error(this.$t('common.error')) this.equipment = null } finally { this.loading = false } }, async checkTimeAvailability() { if (!this.form.startDateTime || !this.form.endDateTime) { this.timeConflict = false return } if (this.form.startDateTime >= this.form.endDateTime) { this.timeConflict = true return } try { const equipmentId = this.equipment.id const startDate = this.formatDateTime(this.form.startDateTime) const endDate = this.formatDateTime(this.form.endDateTime) const response = await equipmentApi.getAvailability(equipmentId, startDate, endDate) // 检查是否有冲突 this.timeConflict = response.data.available.includes(false) } catch (error) { console.error('Failed to check availability:', error) this.$message.error(this.$t('common.error')) this.timeConflict = true } }, // 处理预约类型变更 handleReservationTypeChange(value) { if (value === 'recurring') { // 跳转到循环预约表单 this.$router.push(`/equipment/${this.equipment.id}/recurring-reserve`) } }, submitForm() { this.$refs.reservationForm.validate(async (valid) => { if (!valid) { return false } if (this.timeConflict) { this.$message.error(this.$t('reservation.timeConflict')) return false } // 如果选择了循环预约，跳转到循环预约表单 if (this.form.reservationType === 'recurring') { this.$router.push(`/equipment/${this.equipment.id}/recurring-reserve`) return } this.submitting = true try { const reservationData = { equipment_id: this.equipment.id, user_name: this.form.userName, user_department: this.form.userDepartment, user_contact: this.form.userContact, user_email: this.form.userEmail || undefined, start_datetime: this.formatDateTime(this.form.startDateTime), end_datetime: this.formatDateTime(this.form.endDateTime), purpose: this.form.purpose || undefined, lang: this.$i18n.locale } const response = await reservationApi.createReservation(reservationData) if (response.data.success) { // 获取预定码和二维码 this.reservationCode = response.data.data.reservation_code this.successDialogVisible = true } else { this.$message.error(response.data.message || this.$t('common.error')) } } catch (error) { console.error('Failed to create reservation:', error) this.$message.error(this.$t('common.error')) } finally { this.submitting = false } }) }, resetForm() { this.$refs.reservationForm.resetFields() this.timeConflict = false }, viewReservation() { this.$router.push(`/reservation/${this.reservationCode}`) }, closeSuccessDialog() { this.successDialogVisible = false this.resetForm() this.$router.push('/equipment') }, // 保存二维码图片 link.click(); document.body.removeChild(link); } catch (error) { console.error(\\\"保存二维码失败:\\\", error); } getFullImageUrl(url) { if (!url) return ''; // 如果已经是完整URL，直接返回 if (url.startsWith('http://') || url.startsWith('https://')) { return url; } // 如果是相对路径，添加基础URL if (url.startsWith('/')) { return this.baseUrl + url; } // 其他情况，添加基础URL和斜杠 return this.baseUrl + '/' + url; } } } \")])])])], 1)]);\n};\nvar staticRenderFns = [];\nexport { render, staticRenderFns };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}