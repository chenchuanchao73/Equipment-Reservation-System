{"ast":null,"code":"import { reservationApi, equipmentApi } from '@/api';\nimport { isReservationExpired } from '@/utils/date';\nimport axios from 'axios';\nexport default {\n  name: 'AdminDashboard',\n  data() {\n    return {\n      loading: false,\n      stats: {\n        totalEquipment: 0,\n        availableEquipment: 0,\n        totalReservation: 0,\n        activeReservation: 0\n      },\n      recentReservations: []\n    };\n  },\n  created() {\n    this.fetchData();\n  },\n  methods: {\n    async fetchData() {\n      this.loading = true;\n      try {\n        // 使用统计API获取仪表盘数据\n        const dashboardResponse = await axios.get('/api/statistics/dashboard');\n        const dashboardData = dashboardResponse.data;\n        this.stats.totalEquipment = dashboardData.total_equipment;\n        this.stats.availableEquipment = dashboardData.available_equipment;\n        this.stats.totalReservation = dashboardData.total_reservation;\n        this.stats.activeReservation = dashboardData.active_reservation;\n\n        // 处理最近预定数据\n        this.recentReservations = dashboardData.recent_reservations.map(reservation => ({\n          id: reservation.id,\n          reservation_number: reservation.reservation_number,\n          // 添加预约序号字段\n          reservation_code: reservation.reservation_code,\n          equipment_id: reservation.equipment_id,\n          equipment_name: reservation.equipment_name,\n          user_name: reservation.user_name,\n          user_department: reservation.user_department || '',\n          user_contact: reservation.user_contact || '',\n          start_datetime: reservation.start_datetime,\n          end_datetime: reservation.end_datetime,\n          status: reservation.status,\n          created_at: reservation.created_at\n        }));\n      } catch (error) {\n        console.error('Failed to fetch dashboard data:', error);\n        this.$message.error(this.$t('common.error'));\n      } finally {\n        this.loading = false;\n      }\n    },\n    formatDateTime(row, column, cellValue) {\n      if (!cellValue) return '';\n      const date = new Date(cellValue);\n      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;\n    },\n    getStatusType(reservation) {\n      // 如果预约已取消，返回红色\n      if (reservation.status === 'cancelled') {\n        return 'danger';\n      }\n\n      // 如果预约已过期，返回橙色\n      if (isReservationExpired(reservation.end_datetime)) {\n        return 'warning';\n      }\n\n      // 如果预约正在进行中，返回蓝色\n      const now = new Date();\n      const start = new Date(reservation.start_datetime);\n      const end = new Date(reservation.end_datetime);\n      if (now >= start && now <= end) {\n        return 'primary';\n      }\n\n      // 如果预约已确认且未开始，返回绿色\n      // “已确认”状态出现在预约被管理员批准，但还未开始使用的情况\n      return 'success';\n    },\n    getStatusText(reservation) {\n      // 如果预约已取消，显示“已取消”\n      if (reservation.status === 'cancelled') {\n        return this.$t('reservation.cancelled');\n      }\n\n      // 如果预约已过期，显示“已过期”\n      if (isReservationExpired(reservation.end_datetime)) {\n        return this.$t('reservation.expired');\n      }\n\n      // 如果预约正在进行中，显示“使用中”\n      const now = new Date();\n      const start = new Date(reservation.start_datetime);\n      const end = new Date(reservation.end_datetime);\n      if (now >= start && now <= end) {\n        return this.$t('reservation.inUse');\n      }\n\n      // 如果预约已确认且未开始，显示“已确认”\n      // “已确认”状态出现在预约被管理员批准，但还未开始使用的情况\n      return this.$t('reservation.confirmed');\n    },\n    viewReservation(reservation) {\n      // 计算当前预约的实际状态文本和类型\n      const statusText = this.getStatusText(reservation);\n      const statusType = this.getStatusType(reservation);\n      console.log('计算的状态信息:', {\n        statusText,\n        statusType,\n        dbStatus: reservation.status,\n        startTime: reservation.start_datetime,\n        endTime: reservation.end_datetime,\n        reservationNumber: reservation.reservation_number\n      });\n\n      // 构建URL，添加预约码、时间参数、预约序号和计算好的状态信息\n      const url = {\n        path: `/admin/reservation/${reservation.reservation_code}`,\n        query: {\n          startTime: reservation.start_datetime,\n          endTime: reservation.end_datetime,\n          displayStatus: statusText,\n          displayStatusType: statusType,\n          reservationNumber: reservation.reservation_number // 添加预约序号参数\n        }\n      };\n\n      // 每次查看预约时，都重新设置一个标记，表示需要显示预约序号通知\n      localStorage.setItem('show_reservation_number_notification', 'true');\n\n      // 清除之前的预约序号，确保每次都使用新的预约序号\n      localStorage.removeItem('current_reservation_number');\n\n      // 将预约序号保存到localStorage，以便在页面刷新后仍然可以使用\n      if (reservation.reservation_number) {\n        localStorage.setItem('current_reservation_number', reservation.reservation_number);\n        console.log('保存预约序号到localStorage:', reservation.reservation_number);\n\n        // 强制使用预约序号查询，而不是预约码\n        localStorage.setItem('force_use_reservation_number', 'true');\n      }\n      this.$router.push(url);\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}