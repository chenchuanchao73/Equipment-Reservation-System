{"ast":null,"code":"import { recurringReservationApi, reservationApi } from '@/api';\nimport { isReservationExpired } from '@/utils/date';\nexport default {\n  name: 'RecurringReservationDetail',\n  data() {\n    return {\n      recurringReservationId: null,\n      recurringReservation: null,\n      childReservations: [],\n      loading: true,\n      childReservationsLoading: false,\n      error: false,\n      errorMessage: '',\n      includePastReservations: true,\n      // 默认选中\"包含已过期预约\"\n      cancelDialogVisible: false,\n      userEmail: '',\n      cancelLoading: false,\n      fromChildReservation: false,\n      highlightReservationNumber: null // 用于高亮显示特定的子预约\n    };\n  },\n  props: {\n    id: {\n      type: [String, Number],\n      required: false\n    }\n  },\n  created() {\n    // 优先使用props中的id，如果没有则使用路由参数\n    this.recurringReservationId = this.id || this.$route.params.id;\n    console.log('Recurring reservation ID:', this.recurringReservationId);\n\n    // 检查是否是从子预约详情页面返回的\n    this.fromChildReservation = this.$route.query.fromChild === 'true';\n\n    // 检查是否有预约序号参数，用于高亮显示特定的子预约\n    if (this.$route.query.reservation_number) {\n      this.highlightReservationNumber = this.$route.query.reservation_number;\n      console.log('高亮显示预约序号:', this.highlightReservationNumber);\n    }\n    this.loadRecurringReservation();\n  },\n  // 添加activated钩子函数，在组件被激活时调用（如从子预约详情页面返回）\n  activated() {\n    // 检查子预约状态是否发生变化\n    this.checkChildReservationUpdates();\n  },\n  methods: {\n    // 加载循环预约详情\n    async loadRecurringReservation() {\n      this.loading = true;\n      this.error = false;\n      try {\n        const response = await recurringReservationApi.getRecurringReservation(this.recurringReservationId);\n        if (response.data.success) {\n          this.recurringReservation = response.data.data;\n          this.userEmail = this.recurringReservation.user_email || '';\n          this.loadChildReservations();\n        } else {\n          this.error = true;\n          this.errorMessage = response.data.message || this.$t('reservation.failedToLoadReservation');\n        }\n      } catch (error) {\n        console.error('Failed to load recurring reservation:', error);\n        this.error = true;\n        this.errorMessage = error.response?.data?.detail || this.$t('reservation.failedToLoadReservation');\n      } finally {\n        this.loading = false;\n      }\n    },\n    // 加载子预约列表\n    async loadChildReservations() {\n      this.childReservationsLoading = true;\n      try {\n        // 始终包含已过期的预约，设置include_past=1\n        const response = await recurringReservationApi.getChildReservations(this.recurringReservationId, 1 // 始终设置为1，表示包含已过期的预约\n        );\n        if (response.data.success) {\n          // 获取所有子预约\n          this.childReservations = response.data.reservations || [];\n\n          // 如果includePastReservations为false，则在前端过滤掉已过期的预约\n          if (!this.includePastReservations) {\n            const now = new Date();\n            this.childReservations = this.childReservations.filter(reservation => {\n              // 保留未过期的预约和已取消的预约\n              const endTime = new Date(reservation.end_datetime);\n              return endTime >= now || reservation.status === 'cancelled';\n            });\n          }\n\n          // 按预约序号排序\n          this.childReservations.sort((a, b) => {\n            // 从预约序号中提取数字部分进行比较\n            const numA = a.reservation_number ? parseInt(a.reservation_number.replace(/\\D/g, '')) : 0;\n            const numB = b.reservation_number ? parseInt(b.reservation_number.replace(/\\D/g, '')) : 0;\n            return numA - numB;\n          });\n          console.log('Child reservations loaded:', this.childReservations.length);\n        } else {\n          this.$message.error(response.data.message || this.$t('reservation.failedToLoadChildReservations'));\n        }\n      } catch (error) {\n        console.error('Failed to load child reservations:', error);\n        this.$message.error(this.$t('reservation.failedToLoadChildReservations'));\n      } finally {\n        this.childReservationsLoading = false;\n      }\n    },\n    // 返回上一页\n    goBack() {\n      // 对于所有情况，直接返回到个人预约管理页面\n      window.location.href = '/#/reservation/query';\n    },\n    // 查看子预约详情\n    viewChildReservation(reservation) {\n      // 检查是否有预约序号\n      if (reservation.reservation_number) {\n        console.log('通过预约序号查看子预约详情:', reservation.reservation_number);\n\n        // 使用预约序号直接跳转到预约详情页面\n        const reservationNumber = reservation.reservation_number;\n        const reservationCode = reservation.reservation_code;\n        console.log('准备跳转到预约详情页面:', {\n          reservationNumber,\n          reservationCode\n        });\n\n        // 构建查询参数\n        const query = {\n          child: 'true',\n          recurringId: this.recurringReservation.id,\n          code: reservationCode // 添加预约码作为查询参数\n        };\n\n        // 保留用户联系方式参数（如果有）\n        if (this.$route.query.userContact) {\n          console.log('viewChildReservation - 保留用户联系方式参数:', this.$route.query.userContact);\n          query.userContact = this.$route.query.userContact;\n        }\n\n        // 保留来源参数（如果有）\n        if (this.$route.query.from) {\n          console.log('viewChildReservation - 保留来源参数:', this.$route.query.from);\n          query.from = this.$route.query.from;\n        }\n        console.log('viewChildReservation - 跳转到子预约详情页面，参数:', query);\n        this.$router.push({\n          path: `/reservation/number/${reservationNumber}`,\n          query: query\n        });\n\n        // 将预约序号和预约码保存到localStorage，以便在页面刷新后仍然可以使用\n        localStorage.setItem('current_reservation_number', reservation.reservation_number);\n        localStorage.setItem('current_reservation_code', reservation.reservation_code);\n        console.log('查看子预约详情:', {\n          id: reservation.id,\n          reservation_code: reservation.reservation_code,\n          reservation_number: reservation.reservation_number,\n          startTime: reservation.start_datetime,\n          endTime: reservation.end_datetime\n        });\n      } else if (reservation.id) {\n        // 如果没有预约序号但有ID，则使用旧方法\n        // 构建查询参数\n        const query = {\n          child: 'true',\n          id: reservation.id,\n          recurringId: this.recurringReservation.id,\n          startTime: reservation.start_datetime,\n          endTime: reservation.end_datetime\n        };\n\n        // 保留用户联系方式参数（如果有）\n        if (this.$route.query.userContact) {\n          console.log('viewChildReservation(旧方法) - 保留用户联系方式参数:', this.$route.query.userContact);\n          query.userContact = this.$route.query.userContact;\n        }\n\n        // 保留来源参数（如果有）\n        if (this.$route.query.from) {\n          console.log('viewChildReservation(旧方法) - 保留来源参数:', this.$route.query.from);\n          query.from = this.$route.query.from;\n        }\n        console.log('viewChildReservation(旧方法) - 跳转到子预约详情页面，参数:', query);\n        this.$router.push({\n          path: `/reservation/${reservation.reservation_code}`,\n          query: query\n        });\n        console.log('使用旧方法查看子预约详情:', {\n          id: reservation.id,\n          reservation_code: reservation.reservation_code,\n          startTime: reservation.start_datetime,\n          endTime: reservation.end_datetime\n        });\n      } else {\n        this.$message.warning('无法查看子预约详情，缺少预约序号和ID');\n      }\n    },\n    // 取消子预约\n    async cancelChildReservation(reservation) {\n      try {\n        console.log('准备取消子预约:', reservation);\n        console.log('子预约序号:', reservation.reservation_number);\n        const result = await this.$confirm(this.$t('reservation.cancelConfirmation'), this.$t('common.warning'), {\n          confirmButtonText: this.$t('common.confirm'),\n          cancelButtonText: this.$t('common.cancel'),\n          type: 'warning'\n        });\n        if (result === 'confirm') {\n          // 添加预约序号参数，确保只取消特定的子预约\n          const requestData = {\n            user_email: this.recurringReservation.user_email\n          };\n\n          // 添加预约序号参数，确保只取消特定的子预约\n          if (reservation.reservation_number) {\n            requestData.reservation_number = reservation.reservation_number;\n            console.log('预约序号参数存在:', reservation.reservation_number);\n          } else {\n            console.warn('预约序号参数不存在，将取消所有具有相同预约码的预约');\n          }\n          console.log('取消子预约请求参数:', requestData);\n          console.log('预约码:', reservation.reservation_code);\n          const response = await reservationApi.cancelReservation(reservation.reservation_code, requestData);\n          console.log('取消子预约响应:', response.data);\n          if (response.data.success) {\n            this.$message.success(this.$t('reservation.cancelSuccess'));\n\n            // 直接更新子预约状态为已取消\n            reservation.status = 'cancelled';\n\n            // 保存状态变更到localStorage\n            this.saveChildReservationStatus(reservation, 'cancelled');\n\n            // 强制刷新整个页面，确保获取最新数据\n            console.log('子预约已取消，即将刷新页面...');\n            setTimeout(() => {\n              window.location.reload(true);\n            }, 1000);\n          } else {\n            this.$message.error(response.data.message || this.$t('reservation.cancelFailed'));\n          }\n        }\n      } catch (error) {\n        if (error !== 'cancel') {\n          console.error('Failed to cancel reservation:', error);\n          this.$message.error(this.$t('reservation.cancelFailed'));\n        }\n      }\n    },\n    // 保存子预约状态到localStorage\n    saveChildReservationStatus(reservation, status) {\n      if (!reservation) return;\n\n      // 使用预约码作为键\n      const stateKey = `reservation_status_${reservation.reservation_code}`;\n\n      // 保存状态信息\n      const state = {\n        statusText: this.getChildStatusText({\n          ...reservation,\n          status: status\n        }),\n        statusType: this.getChildStatusType({\n          ...reservation,\n          status: status\n        }),\n        dbStatus: status,\n        forcedStatus: status,\n        timestamp: new Date().getTime(),\n        permanent: true,\n        reservationCode: reservation.reservation_code\n      };\n      console.log('保存子预约状态到localStorage:', state);\n      localStorage.setItem(stateKey, JSON.stringify(state));\n    },\n    // 检查子预约状态是否发生变化\n    checkChildReservationUpdates() {\n      console.log('检查子预约状态是否发生变化');\n\n      // 检查是否有子预约状态变更标记\n      const recurringStateKey = `recurring_reservation_${this.recurringReservationId}_child_status_changed`;\n      const recurringStateStr = localStorage.getItem(recurringStateKey);\n      if (recurringStateStr) {\n        try {\n          const recurringState = JSON.parse(recurringStateStr);\n\n          // 检查状态变更是否还是新鲜的（5分钟内）\n          const now = new Date().getTime();\n          const fiveMinutes = 5 * 60 * 1000;\n          if (now - recurringState.timestamp <= fiveMinutes) {\n            console.log('检测到子预约状态变更，刷新列表:', recurringState);\n\n            // 移除状态变更标记\n            localStorage.removeItem(recurringStateKey);\n\n            // 重新加载子预约列表\n            this.loadChildReservations();\n            return;\n          } else {\n            // 如果状态变更过期，移除它\n            localStorage.removeItem(recurringStateKey);\n          }\n        } catch (e) {\n          console.error('解析子预约状态变更标记时出错:', e);\n        }\n      }\n\n      // 如果没有子预约状态变更标记，检查每个子预约的状态\n      if (this.childReservations.length > 0) {\n        let needRefresh = false;\n\n        // 检查每个子预约的状态\n        for (let i = 0; i < this.childReservations.length; i++) {\n          const reservation = this.childReservations[i];\n          const stateKey = `reservation_status_${reservation.reservation_code}`;\n          const savedStateStr = localStorage.getItem(stateKey);\n          if (savedStateStr) {\n            try {\n              const savedState = JSON.parse(savedStateStr);\n\n              // 检查保存的状态是否还是新鲜的（5分钟内）\n              const now = new Date().getTime();\n              const fiveMinutes = 5 * 60 * 1000;\n              if (now - savedState.timestamp <= fiveMinutes) {\n                console.log(`检测到子预约 ${reservation.reservation_code} 的状态可能已更改，保存的状态:`, savedState);\n\n                // 如果状态已变更为已取消，需要刷新子预约列表\n                if (savedState.forcedStatus === 'cancelled' || savedState.statusText === this.$t('reservation.cancelled') && savedState.statusType === 'danger') {\n                  console.log(`子预约 ${reservation.reservation_code} 已被标记为已取消，需要刷新列表`);\n                  needRefresh = true;\n                  break;\n                }\n              } else {\n                // 如果状态过期，则移除它\n                localStorage.removeItem(stateKey);\n              }\n            } catch (e) {\n              console.error(`解析子预约 ${reservation.reservation_code} 的保存状态时出错:`, e);\n            }\n          }\n        }\n\n        // 如果需要刷新，重新加载子预约列表\n        if (needRefresh) {\n          console.log('检测到子预约状态变更，刷新列表');\n          this.loadChildReservations();\n        }\n      }\n    },\n    // 显示取消循环预约对话框\n    showCancelDialog() {\n      this.cancelDialogVisible = true;\n    },\n    // 确认取消循环预约\n    async confirmCancel() {\n      this.cancelLoading = true;\n      try {\n        const response = await recurringReservationApi.cancelRecurringReservation(this.recurringReservationId, this.userEmail || null);\n        if (response.data.success) {\n          this.$message.success(this.$t('reservation.cancelSuccess'));\n          this.cancelDialogVisible = false;\n          this.loadRecurringReservation();\n        } else {\n          this.$message.error(response.data.message || this.$t('reservation.cancelFailed'));\n        }\n      } catch (error) {\n        console.error('Failed to cancel recurring reservation:', error);\n        this.$message.error(this.$t('reservation.cancelFailed'));\n      } finally {\n        this.cancelLoading = false;\n      }\n    },\n    // 格式化日期\n    formatDate(dateStr) {\n      if (!dateStr) return '';\n      const date = new Date(dateStr);\n      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;\n    },\n    // 格式化时间\n    formatTime(timeStr) {\n      if (!timeStr) return '';\n      return timeStr.substring(0, 5);\n    },\n    // 格式化日期时间\n    formatDateTime(row, column, cellValue) {\n      if (!cellValue) return '';\n      const date = new Date(cellValue);\n      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;\n    },\n    // 格式化星期几\n    formatDaysOfWeek(days) {\n      if (!days || days.length === 0) return '';\n      const dayNames = [this.$t('reservation.sunday'), this.$t('reservation.monday'), this.$t('reservation.tuesday'), this.$t('reservation.wednesday'), this.$t('reservation.thursday'), this.$t('reservation.friday'), this.$t('reservation.saturday')];\n      return days.map(day => dayNames[day]).join(', ');\n    },\n    // 格式化每月几号\n    formatDaysOfMonth(days) {\n      if (!days || days.length === 0) return '';\n      return days.join(', ');\n    },\n    // 获取循环模式文本\n    getPatternText(pattern) {\n      const patterns = {\n        'daily': this.$t('reservation.daily'),\n        'weekly': this.$t('reservation.weekly'),\n        'monthly': this.$t('reservation.monthly'),\n        'custom': this.$t('reservation.custom')\n      };\n      return patterns[pattern] || pattern;\n    },\n    // 获取循环预约状态类型\n    getStatusType(reservation) {\n      if (reservation.status === 'cancelled') {\n        return 'danger';\n      }\n      return 'success';\n    },\n    // 获取循环预约状态文本\n    getStatusText(reservation) {\n      if (reservation.status === 'cancelled') {\n        return this.$t('reservation.cancelled');\n      }\n      return this.$t('reservation.active');\n    },\n    // 获取子预约状态类型\n    getChildStatusType(reservation) {\n      // 如果预约已取消，返回红色\n      if (reservation.status === 'cancelled') {\n        return 'danger';\n      }\n\n      // 如果预约已过期，返回橙色\n      if (isReservationExpired(reservation.end_datetime)) {\n        return 'warning';\n      }\n\n      // 如果预约正在进行中，返回蓝色\n      const now = new Date();\n      const start = new Date(reservation.start_datetime);\n      const end = new Date(reservation.end_datetime);\n      if (now >= start && now <= end) {\n        return 'primary';\n      }\n\n      // 如果预约已确认且未开始，返回绿色\n      return 'success';\n    },\n    // 获取子预约状态文本\n    getChildStatusText(reservation) {\n      // 如果预约已取消，显示\"已取消\"\n      if (reservation.status === 'cancelled') {\n        return this.$t('reservation.cancelled');\n      }\n\n      // 如果预约已过期，显示\"已过期\"\n      if (isReservationExpired(reservation.end_datetime)) {\n        return this.$t('reservation.expired');\n      }\n\n      // 如果预约正在进行中，显示\"进行中\"\n      const now = new Date();\n      const start = new Date(reservation.start_datetime);\n      const end = new Date(reservation.end_datetime);\n      if (now >= start && now <= end) {\n        return this.$t('reservation.ongoing');\n      }\n\n      // 如果预约已确认且未开始，显示\"已确认\"\n      return this.$t('reservation.confirmed');\n    },\n    // 获取行的类名，用于高亮显示特定的子预约\n    getRowClassName({\n      row\n    }) {\n      if (this.highlightReservationNumber && row.reservation_number === this.highlightReservationNumber) {\n        return 'highlighted-row';\n      }\n      return '';\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}